<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sistema de Observaciones de Seguridad</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js">
document.addEventListener("DOMContentLoaded", function() {
    const form = document.querySelector("form");
    const guardarBtn = document.querySelector("button[type='submit'], input[type='submit']");

    if (form && guardarBtn) {
        form.addEventListener("submit", function(event) {
            event.preventDefault(); // Prevent actual submission
            // Simulate saving logic here (e.g., send data to server)
            // After saving, reset the form
            form.reset();
        });
    }
});
</script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
    :root {
      --primary-blue: #1a73e8;
      --dark-blue: #0d47a1;
      --light-blue: #e8f0fe;
      --primary-green: #34a853;
      --dark-green: #1e8e3e;
      --light-green: #e6f4ea;
      --white: #ffffff;
      --light-gray: #f5f5f5;
      --medium-gray: #e0e0e0;
      --dark-gray: #5f6368;
      --black: #202124;
      --border-radius: 8px;
      --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
    }
    
    body {
      background-color: var(--light-gray);
      color: var(--black);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    header {
      background-color: var(--white);
      box-shadow: var(--box-shadow);
      padding: 1rem 0;
      margin-bottom: 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }
    
    .logo {
      display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    font-weight: 700;
    font-size: 1.2rem;
    color: var(--primary-blue);
    }
    
    .logo-image {
    height: 40px; /* Ajusta este valor según necesites */
    width: auto; /* Mantiene la proporción original */
    max-height: 100%; /* Evita que sea más alto que su contenedor */
  }
  
  /* Para pantallas pequeñas */
  @media (max-width: 768px) {
    .logo-image {
      height: 30px;
    }
    
    .logo span {
      font-size: 1rem;
    }
  }
    .logo-icon {
      color: var(--primary-green);
    }
    
    .auth-section {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background-color: var(--primary-blue);
      color: var(--white);
    }
    
    .btn-primary:hover {
      background-color: var(--dark-blue);
    }
    
    .btn-success {
      background-color: var(--primary-green);
      color: var(--white);
    }
    
    .btn-success:hover {
      background-color: var(--dark-green);
    }
    
    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary-blue);
      color: var(--primary-blue);
    }
    
    .btn-outline:hover {
      background-color: var(--light-blue);
    }
    
    /* Formulario mejorado */
    .form-container {
      background-color: var(--white);
      padding: 2.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 2rem;
    }
    
    h2 {
      color: var(--primary-blue);
      text-align: center;
      margin-bottom: 2rem;
      font-size: 1.8rem;
    }
    
    .form-section {
      margin-bottom: 1.5rem;
      padding: 1.5rem;
      background-color: var(--light-gray);
      border-radius: var(--border-radius);
      border-left: 4px solid var(--primary-blue);
    }
    
    .form-section h3 {
      margin-top: 0;
      color: var(--primary-blue);
      border-bottom: 1px solid var(--medium-gray);
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }
    .form-control {
  transition: all 0.3s ease;
  padding: 10px 15px;
  border: 1px solid #ddd;
  border-radius: 4px;
  width: 100%;
  margin-bottom: 10px;
}

#customAreaInput {
  display: none;
  background-color: #f9f9f9;
}

#customAreaInput::placeholder {
  color: #999;
  font-style: italic;
}
    label {
      display: block;
      margin: 1rem 0 0.5rem;
      font-weight: 500;
      color: var(--dark-gray);
    }
    
    input, textarea, select {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid var(--medium-gray);
      border-radius: var(--border-radius);
      box-sizing: border-box;
      font-size: 1rem;
      transition: var(--transition);
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px var(--light-blue);
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    /* Estilos para las secciones de tipo de reporte */
.report-type-section {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background-color: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid var(--primary-blue);
}

.report-type-section h4 {
  margin-top: 0;
  color: var(--primary-blue);
}

/* Estilos para los grupos de radio buttons */
.type-options {
  display: flex;
  gap: 1.5rem;
  margin-top: 0.5rem;
}

.type-option-group {
  flex: 1;
  padding: 1rem;
  border-radius: 6px;
  background-color: white;
  border: 1px solid #dee2e6;
}
    
    .radio-group, .checkbox-group {
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .radio-group label, .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: normal;
      cursor: pointer;
      padding: 0.5rem 0;
    }
    
    .form-row {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .form-row > div {
      flex: 1;
    }
    
    /* Panel de administración */
    .admin-panel {
      display: none;
      margin-top: 2rem;
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background-color: var(--white);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
    }
    
    .stat-card h3 {
      color: var(--dark-gray);
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-blue);
    }
    
    .stat-card.green .value {
      color: var(--primary-green);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--white);
      box-shadow: var(--box-shadow);
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    
    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--medium-gray);
    }
    
    th {
      background-color: var(--primary-blue);
      color: var(--white);
      font-weight: 500;
    }
    
    tr:hover {
      background-color: var(--light-blue);
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-safe {
      background-color: var(--light-green);
      color: var(--dark-green);
    }
    
    .badge-unsafe {
      background-color: #fce8e6;
      color: #d93025;
    }
    
    /* Modal de Login */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 2.5rem;
      border-radius: var(--border-radius);
      width: 100%;
      max-width: 450px;
      box-shadow: var(--box-shadow);
      position: relative;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .stats-cards {
        grid-template-columns: 1fr;
      }
      
      nav {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }
      
      .auth-section {
        width: 100%;
        justify-content: space-between;
      }
      .alert {
  padding: 15px;
  margin: 15px 0;
  border-radius: 4px;
  display: none;
}

.success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
/* Agrega esto a tu sección de estilos */
.evidence-image-container {
  margin: 0.5rem 0;
  text-align: center;
  transform: scale(1.02);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.evidence-image {
  max-width: 100%;
  max-height: 180px; /* Altura máxima reducida */
  width: auto;
  height: auto;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  object-fit: contain; /* Mantiene proporciones sin recortar */
  background-color: #f9f9f9; /* Fondo para imágenes con transparencia */
  padding: 4px;
  transition: transform 0.3s ease;
}

.evidence-image-caption {
  display: block;
  margin-top: 0.5rem;
  font-size: 0.9rem;
  color: #666;
}
    }
  </style>
</head>
<body>
<header>
<nav>
<a class="logo" href="#">
<img alt="Logo Seguridad-HB" class="logo-image" src="logo.png"/>
<span>Seguridad-HB Y CIA S.A.S</span>
</a>
<div class="auth-section">
<button class="btn btn-outline" id="loginBtn">Iniciar Sesión</button>
<button class="btn btn-danger" id="logoutBtn" style="display: none;">Cerrar Sesión</button>
</div>
</nav>
</header>
<div class="container">
<!-- Coloca esto en tu HTML, preferiblemente cerca del formulario -->
<div class="alert" id="alert" style="display: none;"></div>
<!-- Formulario de Observaciones -->
<div class="form-container" id="observationFormContainer">
<h2>Sistema de Observaciones de Seguridad</h2>
<form id="observationForm">
<div class="form-section">
<h3>Información Básica</h3>
<div class="form-row">
<div>
<label for="observationDate">Fecha de la Observación:</label>
<input id="observationDate" required="" type="date"/>
</div>
<div>
<label for="observationTime">Hora de la Observación:</label>
<input id="observationTime" required="" type="time"/>
</div>
</div>
<div class="form-row">
<div>
<label for="observerName">Nombre del Observador:</label>
<input id="observerName" required="" type="text"/>
</div>
<div>
<label for="observerPosition">Cargo del Observador:</label>
<input id="observerPosition" required="" type="text"/>
</div>
</div>
<div class="form-group">
<label for="areaSelector">Área o Lugar de la Observación:</label>
<select class="form-control" id="areaSelector" onchange="handleAreaSelection()">
<option value="">Seleccione un área...</option>
<option value="Taller">Taller</option>
<option value="Campo">Campo</option>
<option value="Oficina">Oficina</option>
<option value="Almacén">Almacén</option>
<option value="Vehículo">Vehículo</option>
<option value="Otra">Otra área (especificar)</option>
</select>
<input class="form-control mt-2" id="customAreaInput" placeholder="Describe el área o lugar" style="display: none;" type="text"/>
</div>
</div>
<div class="form-section">
<h3>Información del Trabajador Observado</h3>
<div class="form-row">
<div>
<label for="workerName">Nombre del Trabajador Observado:</label>
<input id="workerName" type="text"/>
</div>
<div>
<label for="workerPosition">Cargo del Trabajador Observado:</label>
<input id="workerPosition" type="text"/>
</div>
</div>
<label for="observedActivity">Actividad Observada:</label>
<input id="observedActivity" list="activities" required="" type="text"/>
<datalist id="activities">
<option value="Trabajo en altura">
<option value="Manejo de herramientas">
<option value="Operación de maquinaria">
<option value="Manipulación de químicos">
<option value="Movimiento de cargas">
<option value="Trabajo eléctrico">
<option value="Uso de guadaña">
<option value="Soldadura">
</option></option></option></option></option></option></option></option></datalist>
</div>
<div class="form-section">
<h3>Detalles de la Observación</h3>
<h3>Tipo de Observación</h3>
<!-- Selector principal -->
<label>Tipo de Reporte:</label>
<div class="radio-group">
<label>
<input checked="" name="reportType" onchange="toggleObservationType()" type="radio" value="comportamiento"/> Comportamiento
    </label>
<label>
<input name="reportType" onchange="toggleObservationType()" type="radio" value="condicion"/> Condición
    </label>
</div>
<!-- Comportamientos -->
<div id="behaviorSection">
<label>Tipo de Comportamiento:</label>
<div class="radio-group">
<label><input name="observationType" required="" type="radio" value="Comportamiento Seguro"/> Seguro</label>
<label><input name="observationType" type="radio" value="Comportamiento Inseguro"/> Inseguro</label>
</div>
</div>
<!-- Condiciones -->
<div id="conditionSection" style="display: none;">
<label>Tipo de Condición:</label>
<div class="radio-group">
<label><input name="conditionType" type="radio" value="Condición Segura"/> Segura</label>
<label><input name="conditionType" type="radio" value="Condición Insegura"/> Insegura</label>
</div>
</div>
<!-- Severidad (aparece para comportamientos inseguros o condiciones inseguras) -->
<div id="severityContainer" style="display: none;">
<label for="potentialSeverity">Severidad Potencial:</label>
<select id="potentialSeverity">
<option value="Baja">Baja</option>
<option value="Media">Media</option>
<option value="Alta">Alta</option>
<option value="Crítica">Crítica</option>
</select>
</div>
</div>
<label for="observationDescription">Descripción de la Observación:</label>
<textarea id="observationDescription" required=""></textarea>
<label for="correctiveAction">Acción Correctiva Tomada (si aplica):</label>
<textarea id="correctiveAction"></textarea>
<label>¿Se detuvo el trabajo?</label>
<div class="radio-group">
<label><input name="workStopped" type="radio" value="Sí"/> Sí</label>
<label><input checked="" name="workStopped" type="radio" value="No"/> No</label>
</div>
</form></div>
<div class="form-section">
<h3>Evidencia Fotográfica</h3>
<label for="imageInput">Subir imagen de la observación (opcional):</label>
<input accept="image/*" id="imageInput" type="file"/>
</div>
<button class="btn btn-primary" onclick="uploadData()" type="button">
<span>📋</span> Guardar Observación
        </button>
<!--<button type="button" id="exportBtn" onclick="exportToExcel()" class="btn btn-success">
          <span>📊</span> Exportar a Excel
        </button> -->

</div>
<!-- Panel de Administración -->
<div class="admin-panel" id="adminPanel">
<div class="admin-header">
<h2>Panel de Administración</h2>
<div>
<button class="btn btn-success" onclick="exportAllData()">
<span>💾</span> Exportar Todo
          </button>
</div>
</div>
<div class="stats-cards">
<div class="stat-card">
<h3>Total Observaciones</h3>
<div class="value" id="totalObservations">0</div>
</div>
<div class="stat-card green">
<h3>Comportamientos Seguros</h3>
<div class="value" id="safeObservations">0</div>
</div>
<div class="stat-card">
<h3>Comportamientos Inseguros</h3>
<div class="value" id="unsafeObservations">0</div>
</div>
<div class="stat-card">
<h3>Trabajos Detenidos</h3>
<div class="value" id="stoppedWorks">0</div>
</div>
</div>
<div style="overflow-x: auto;">
<table id="observationsTable">
<thead>
<tr>
<th>Fecha</th>
<th>Observador</th>
<th>Área</th>
<th>Tipo</th>
<th>Actividad</th>
<th>Severidad</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="observationsTableBody">
<!-- Datos se cargarán dinámicamente -->
</tbody>
</table>
</div>
</div>

<!-- Modal de Login -->
<div class="modal" id="loginModal">
<div class="modal-content">
<h2 style="margin-bottom: 1.5rem;">Acceso Administrador</h2>
<form id="loginForm">
<label for="adminUsername">Usuario</label>
<input id="adminUsername" required="" type="text"/>
<label for="adminPassword">Contraseña</label>
<input id="adminPassword" required="" type="password"/>
<button class="btn btn-primary" onclick="adminLogin()" style="margin-top: 1.5rem; width: 100%;" type="button">
          Iniciar Sesión
        </button>
</form>
</div>
</div>
<!-- Agrega este modal para mostrar detalles al final del body, antes del cierre </body> -->
<div class="modal" id="detailsModal">
<div class="modal-content" style="max-width: 800px;">
<button onclick="closeDetailsModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
<h2 id="detailsTitle">Detalles de la Observación</h2>
<div id="detailsContent" style="max-height: 70vh; overflow-y: auto; padding-right: 1rem;">
<!-- Los detalles se cargarán aquí dinámicamente -->
</div>
</div>
</div>
<script>
    // Configuración de Firebase (solo para la base de datos)
    const firebaseConfig = {
      apiKey: "AIzaSyB7YAg78tcaXmLAxVow-J1KmVgyR-zd-QY",
      authDomain: "app-sgt-63275.firebaseapp.com",
      databaseURL: "https://app-sgt-63275-default-rtdb.firebaseio.com",
      projectId: "app-sgt-63275",
      storageBucket: "app-sgt-63275.appspot.com",
      messagingSenderId: "683214732490",
      appId: "1:683214732490:web:acac45eb04b37dd7f74833",
      measurementId: "G-S0919EXH0B"
    };

    // Inicializar solo los servicios de Firebase que necesitamos
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Credenciales de administrador (puedes cambiarlas)
    const ADMIN_CREDENTIALS = {
      username: "admin",
      password: "Seguridad123" // Cambia esto por una contraseña segura
    };
    
    // Estado de autenticación
    let isAdminAuthenticated = false;
    
    // Elementos del DOM
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginModal = document.getElementById('loginModal');
    const adminPanel = document.getElementById('adminPanel');
    
    // Mostrar/ocultar modal de login
    loginBtn.addEventListener('click', () => {
      loginModal.style.display = 'flex';
    });
    
    // Cerrar modal al hacer clic fuera
    loginModal.addEventListener('click', (e) => {
      if (e.target === loginModal) {
        loginModal.style.display = 'none';
      }
    });
    
    // Función de login para administradores
    function adminLogin() {
      const username = document.getElementById('adminUsername').value;
      const password = document.getElementById('adminPassword').value;
      
      if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        isAdminAuthenticated = true;
        loginModal.style.display = 'none';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'block';
        adminPanel.style.display = 'block';
        loadAdminData();
        
        // Guardar estado de sesión en localStorage
        localStorage.setItem('adminAuthenticated', 'true');
      } else {
        alert('Credenciales incorrectas. Por favor intente nuevamente.');
      }
    }
    
    // Función para cerrar sesión
    function adminLogout() {
      isAdminAuthenticated = false;
      loginBtn.style.display = 'block';
      logoutBtn.style.display = 'none';
      adminPanel.style.display = 'none';
      
      // Limpiar estado de sesión
      localStorage.removeItem('adminAuthenticated');
    }
    
    // Verificar si hay sesión activa al cargar la página
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('adminAuthenticated') === 'true') {
        isAdminAuthenticated = true;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'block';
        adminPanel.style.display = 'block';
        loadAdminData();
      }
    });
    
    // Cerrar sesión al hacer clic en el botón
    logoutBtn.addEventListener('click', adminLogout);
    
    // Función para cargar datos en el panel de admin
    async function loadAdminData() {
      try {
        const snapshot = await db.ref('observaciones').once('value');
        
        if (!snapshot.exists()) {
          document.getElementById('observationsTableBody').innerHTML = 
            '<tr><td colspan="7">No hay observaciones registradas</td></tr>';
          return;
        }
        
        const observations = [];
        let safeCount = 0;
        let unsafeCount = 0;
        let stoppedCount = 0;
        
        snapshot.forEach(child => {
          const obs = child.val();
          observations.push({
            id: child.key,
            ...obs
          });
          
          if (obs.tipo === 'Comportamiento Seguro') safeCount++;
          else unsafeCount++;
          
          if (obs.trabajoDetenido === 'Sí') stoppedCount++;
        });
        
        // Actualizar estadísticas
        document.getElementById('totalObservations').textContent = observations.length;
        document.getElementById('safeObservations').textContent = safeCount;
        document.getElementById('unsafeObservations').textContent = unsafeCount;
        document.getElementById('stoppedWorks').textContent = stoppedCount;
        
        // Actualizar tabla
        const tableBody = document.getElementById('observationsTableBody');
        tableBody.innerHTML = '';
        
        observations.forEach(obs => {
          const row = document.createElement('tr');
          
          row.innerHTML = `
            <td>${obs.fecha} ${obs.hora}</td>
            <td>${obs.observador.nombre}</td>
            <td>${obs.area}</td>
            <td>
              <span class="badge ${obs.tipo === 'Comportamiento Seguro' ? 'badge-safe' : 'badge-unsafe'}">
                ${obs.tipo}
              </span>
            </td>
            <td>${obs.actividad}</td>
            <td>${obs.severidad || 'N/A'}</td>
            <td>
              <button onclick="viewObservation('${obs.id}')" class="btn btn-outline" style="padding: 0.5rem;">
                Ver Detalles
              </button>
            </td>
          `;
          
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error('Error cargando datos de admin:', error);
        alert('Error al cargar los datos: ' + error.message);
      }
    }
    // Función para alternar entre comportamientos y condiciones
function toggleObservationType() {
  const reportType = document.querySelector('input[name="reportType"]:checked').value;
  const behaviorSection = document.getElementById('behaviorSection');
  const conditionSection = document.getElementById('conditionSection');
  
  if (reportType === 'comportamiento') {
    behaviorSection.style.display = 'block';
    conditionSection.style.display = 'none';
  } else {
    behaviorSection.style.display = 'none';
    conditionSection.style.display = 'block';
  }
  
  // Actualizar visibilidad de severidad
  updateSeverityVisibility();
}

// Función para actualizar la visibilidad de severidad
function updateSeverityVisibility() {
  const reportType = document.querySelector('input[name="reportType"]:checked').value;
  let showSeverity = false;
  
  if (reportType === 'comportamiento') {
    const selected = document.querySelector('input[name="observationType"]:checked');
    showSeverity = selected && selected.value === 'Comportamiento Inseguro';
  } else {
    const selected = document.querySelector('input[name="conditionType"]:checked');
    showSeverity = selected && selected.value === 'Condición Insegura';
  }
  
  document.getElementById('severityContainer').style.display = 
    showSeverity ? 'block' : 'none';
}

// Event listeners para cambios en los radio buttons
document.querySelectorAll('input[name="observationType"]').forEach(radio => {
  radio.addEventListener('change', updateSeverityVisibility);
});

document.querySelectorAll('input[name="conditionType"]').forEach(radio => {
  radio.addEventListener('change', updateSeverityVisibility);
});

// Inicializar al cargar
document.addEventListener('DOMContentLoaded', function() {
  toggleObservationType();
});
    // Función para ver detalles de una observación
  async function viewObservation(observationId) {
    try {
      const snapshot = await db.ref('observaciones/' + observationId).once('value');
      
      if (!snapshot.exists()) {
        alert('La observación no existe');
        return;
      }
      
      const observation = snapshot.val();
      
      // Construir el HTML con los detalles
      let detailsHTML = `
        <div class="details-grid">
          <div>
            <div class="details-section">
              <h3>Información Básica</h3>
              <div class="detail-item">
                <div class="detail-label">Fecha y Hora:</div>
                <div class="detail-value">${observation.fecha} ${observation.hora}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Área:</div>
                <div class="detail-value">${observation.area}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Tipo:</div>
                <div class="detail-value">
                  <span class="badge ${observation.tipo === 'Comportamiento Seguro' ? 'badge-safe' : 'badge-unsafe'}">
                    ${observation.tipo}
                  </span>
                </div>
              </div>
              ${observation.severidad ? `
              <div class="detail-item">
                <div class="detail-label">Severidad:</div>
                <div class="detail-value">${observation.severidad}</div>
              </div>
              ` : ''}
            </div>
            
            <div class="details-section">
              <h3>Observador</h3>
              <div class="detail-item">
                <div class="detail-label">Nombre:</div>
                <div class="detail-value">${observation.observador.nombre}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Cargo:</div>
                <div class="detail-value">${observation.observador.cargo}</div>
              </div>
            </div>
          </div>
          
          <div>
            <div class="details-section">
              <h3>Trabajador Observado</h3>
              <div class="detail-item">
                <div class="detail-label">Nombre:</div>
                <div class="detail-value">${observation.trabajador.nombre || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Cargo:</div>
                <div class="detail-value">${observation.trabajador.cargo || 'N/A'}</div>
              </div>
            </div>
            
            <div class="details-section">
              <h3>Actividad</h3>
              <div class="detail-item">
                <div class="detail-value">${observation.actividad}</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="details-section">
          <h3>Descripción</h3>
          <div class="detail-item">
            <div class="detail-value">${observation.descripcion}</div>
          </div>
        </div>
        
        ${observation.accionCorrectiva ? `
        <div class="details-section">
          <h3>Acción Correctiva</h3>
          <div class="detail-item">
            <div class="detail-value">${observation.accionCorrectiva}</div>
          </div>
        </div>
        ` : ''}
        
        <div class="details-section">
          <h3>Estado del Trabajo</h3>
          <div class="detail-item">
            <div class="detail-value">${observation.trabajoDetenido === 'Sí' ? 'Trabajo fue detenido' : 'Trabajo no fue detenido'}</div>
          </div>
        </div>
      `;
      
      // Agregar la imagen si existe
      if (observation.imagenUrl) {
  detailsHTML += `
    <div class="evidence-image-container">
      <h3>Evidencia Fotográfica</h3>
      <img src="${observation.imagenUrl}" 
           alt="Evidencia de observación" 
           class="evidence-image">
      <span class="evidence-image-caption">Evidencia</span>
    </div>
  `;
}
      
      // Mostrar en el modal
      document.getElementById('detailsContent').innerHTML = detailsHTML;
      document.getElementById('detailsModal').style.display = 'flex';
      
    } catch (error) {
      console.error('Error mostrando detalles:', error);
      alert('Error al cargar los detalles: ' + error.message);
    }
  }
  
  // Función para cerrar el modal de detalles
  function closeDetailsModal() {
    document.getElementById('detailsModal').style.display = 'none';
  }
    
    // Función para exportar todos los datos
    async function exportAllData() {
  try {
    const snapshot = await db.ref('observaciones').once('value');
    
    if (!snapshot.exists()) {
      showAlert('No hay observaciones para exportar', false);
      return;
    }
    
    // Preparar datos para Excel
    const excelData = [];
    snapshot.forEach(child => {
      const item = child.val();
      
      // Crear objeto con los datos
      const rowData = {
        'Fecha': item.fecha,
        'Hora': item.hora,
        'Observador': item.observador.nombre,
        'Cargo Observador': item.observador.cargo,
            'Área': item.area,
            'Trabajador Observado': item.trabajador.nombre || 'N/A',
            'Cargo Trabajador': item.trabajador.cargo || 'N/A',
            'Actividad': item.actividad,
            'Tipo': item.tipo,
            'Descripción': item.descripcion,
            'Acción Correctiva': item.accionCorrectiva || 'Ninguna',
            'Trabajo Detenido': item.trabajoDetenido,
            'Severidad': item.tipo === 'Comportamiento Inseguro' ? item.severidad : 'N/A',
            'Fecha Registro': new Date(item.timestamp).toLocaleString(),
        'URL Imagen': item.imagenUrl || 'Sin imagen'
      };
      
      // Si hay imagen, la convertimos en hipervínculo
      if (item.imagenUrl) {
        rowData['Enlace Imagen'] = {
          v: 'Ver imagen',
          l: item.imagenUrl, // URL del enlace
          t: 's' // Tipo string
        };
      } else {
        rowData['Enlace Imagen'] = 'N/A';
      }
      
      excelData.push(rowData);
    });
    
    // Crear hoja de cálculo
    const ws = XLSX.utils.json_to_sheet(excelData);
    
    // Ajustar ancho de columnas
    ws['!cols'] = [
      { wch: 10 }, // Fecha
      { wch: 8 },  // Hora
      { wch: 20 }, // Observador
      // ... ajusta según tus columnas ...
      { wch: 30 }, // URL Imagen
      { wch: 12 }  // Enlace Imagen
    ];
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Observaciones");
    
    // Exportar archivo
    XLSX.writeFile(wb, 'observaciones_con_imagenes.xlsx');
    
  } catch (error) {
    console.error('Error exportando:', error);
    showAlert('Error al exportar: ' + error.message, false);
  }
}
    
    // Mostrar/ocultar severidad según tipo de observación
    document.querySelectorAll('input[name="observationType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.getElementById('severityContainer').style.display = 
          this.value === 'Comportamiento Inseguro' ? 'block' : 'none';
      });
    });
    
    // Establecer fecha actual por defecto
    document.getElementById('observationDate').valueAsDate = new Date();
    
    // API Key de ImgBB
    const imgbbApiKey = '14b96fa28892d3c9e4e201c5dc4df27a';
    
    function showAlert(message, isSuccess) {
      const alertDiv = document.getElementById('alert');
      alertDiv.textContent = message;
      alertDiv.className = `alert ${isSuccess ? 'success' : 'error'}`;
      alertDiv.style.display = 'block';
      
      setTimeout(() => {
        alertDiv.style.display = 'none';
      }, 5000);
    }
    
    async function uploadData() {
  try {
    // 1. Primero obtener el área seleccionada
    const areaValue = getSelectedArea();
    // Obtener tipo de reporte seleccionado
    const reportType = document.querySelector('input[name="reportType"]:checked')?.value;
    
    // Validar tipo de reporte
    if (!reportType) {
      showAlert('Por favor seleccione el tipo de reporte (Comportamiento o Condición)', false);
      return;
    }

    // Obtener valores del formulario
    const observationData = {
      fecha: document.getElementById('observationDate').value,
      hora: document.getElementById('observationTime').value,
      observador: {
        nombre: document.getElementById('observerName').value,
        cargo: document.getElementById('observerPosition').value
      },
      area: areaValue,
      trabajador: {
        nombre: document.getElementById('workerName').value,
        cargo: document.getElementById('workerPosition').value
      },
      actividad: document.getElementById('observedActivity').value,
      tipoReporte: reportType,
      descripcion: document.getElementById('observationDescription').value,
      accionCorrectiva: document.getElementById('correctiveAction').value,
      trabajoDetenido: document.querySelector('input[name="workStopped"]:checked').value,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    // Determinar el tipo específico (comportamiento/condición segura/insegura)
    if (reportType === 'comportamiento') {
      const behaviorType = document.querySelector('input[name="observationType"]:checked')?.value;
      if (!behaviorType) {
        showAlert('Por favor seleccione si el comportamiento es seguro o inseguro', false);
        return;
      }
      observationData.tipo = behaviorType;
      
      // Agregar severidad si es comportamiento inseguro
      if (behaviorType === 'Comportamiento Inseguro') {
        observationData.severidad = document.getElementById('potentialSeverity').value;
      }
    } else {
      const conditionType = document.querySelector('input[name="conditionType"]:checked')?.value;
      if (!conditionType) {
        showAlert('Por favor seleccione si la condición es segura o insegura', false);
        return;
      }
      observationData.tipo = conditionType;
      
      // Agregar severidad si es condición insegura
      if (conditionType === 'Condición Insegura') {
        observationData.severidad = document.getElementById('potentialSeverity').value;
      }
    }
   // Reemplaza la obtención del área por:
observationData.area = getSelectedArea();

// Agrega esta validación:
if (!observationData.area || (document.getElementById('areaSelector').value === 'Otra' && !customAreaInput.value.trim())) {
  showAlert('Por favor especifique el área de observación', false);
  return;
}
    // Validación de campos requeridos
    const requiredFields = {
      'Fecha': observationData.fecha,
      'Hora': observationData.hora,
      'Nombre del observador': observationData.observador.nombre,
      'Cargo del observador': observationData.observador.cargo,
      'Área': observationData.area,
      'Actividad': observationData.actividad,
      'Descripción': observationData.descripcion
    };

    const missingFields = Object.entries(requiredFields)
      .filter(([_, value]) => !value)
      .map(([field]) => field);

    if (missingFields.length > 0) {
      showAlert(`Faltan campos requeridos: ${missingFields.join(', ')}`, false);
      return;
    }

    // Procesar imagen si existe
    const fileInput = document.getElementById('imageInput');
    const file = fileInput.files[0];
    
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        showAlert('La imagen es demasiado grande (máximo 5MB)', false);
        return;
      }
      
      showAlert('Subiendo imagen...', true);
      observationData.imagenUrl = await uploadToImgBB(file);
    }

    // Guardar en Firebase
    showAlert('Guardando observación...', true);
    await db.ref('observaciones').push(observationData);
    
    // Éxito - resetear formulario
    showAlert('¡Observación guardada correctamente!', true);
    document.getElementById('observationForm').reset();
    document.getElementById('observationDate').valueAsDate = new Date();
    document.getElementById('severityContainer').style.display = 'none';
    
    // Actualizar panel de admin si está visible
    if (isAdminAuthenticated) {
      await loadAdminData();
    }

  } catch (error) {
    console.error('Error al guardar:', error);
    showAlert(`Error al guardar: ${error.message || 'Por favor intente nuevamente'}`, false);
  }
}
    function handleAreaSelection() {
  const selector = document.getElementById('areaSelector');
  const customInput = document.getElementById('customAreaInput');
  
  if (selector.value === 'Otra') {
    // Oculta el select y muestra el input
    selector.style.display = 'none';
    customInput.style.display = 'block';
    customInput.focus();
    customInput.value = ''; // Limpia cualquier valor previo
    customInput.required = true;
  }
}

// Función para restaurar el selector si el usuario cambia de opinión
function restoreAreaSelector() {
  const selector = document.getElementById('areaSelector');
  const customInput = document.getElementById('customAreaInput');
  
  if (customInput.value === '') {
    selector.style.display = 'block';
    customInput.style.display = 'none';
    selector.value = '';
    customInput.required = false;
  }
}

// Al enviar el formulario
function getSelectedArea() {
  const selector = document.getElementById('areaSelector');
  const customInput = document.getElementById('customAreaInput');
  
  return selector.value === 'Otra' ? customInput.value : selector.value;
}
    function uploadToImgBB(file) {
      return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('image', file);
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `https://api.imgbb.com/1/upload?key=${imgbbApiKey}`);
        
        xhr.onload = () => {
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            resolve(response.data.url);
          } else {
            reject(new Error('Error al subir imagen'));
          }
        };
        
        xhr.onerror = () => {
          reject(new Error('Error de red'));
        };
        
        xhr.send(formData);
      });
    }
    
    async function exportToExcel() {
      try {
        const snapshot = await db.ref('observaciones').once('value');
        
        if (!snapshot.exists()) {
          showAlert('No hay observaciones para exportar', false);
          return;
        }
        
        // Preparar datos para Excel
        const excelData = [];
        snapshot.forEach(child => {
          const item = child.val();
          excelData.push({
            'Fecha': item.fecha,
            'Hora': item.hora,
            'Observador': item.observador.nombre,
            'Cargo Observador': item.observador.cargo,
            'Área': item.area,
            'Trabajador Observado': item.trabajador.nombre || 'N/A',
            'Cargo Trabajador': item.trabajador.cargo || 'N/A',
            'Actividad': item.actividad,
            'Tipo de Reporte': item.tipoReporte === 'comportamiento' ? 'Comportamiento' : 'Condición',
            'Tipo': item.tipo,
            'Descripción': item.descripcion,
            'Acción Correctiva': item.accionCorrectiva || 'Ninguna',
            'Trabajo Detenido': item.trabajoDetenido,
            'Severidad': item.tipo === 'Comportamiento Inseguro' ? item.severidad : 'N/A',
            'URL Imagen': item.imagenUrl || 'N/A',
            'Fecha Registro': new Date(item.timestamp).toLocaleString()
          });
        });
        
        // Crear hoja de cálculo
        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Observaciones");
        
        // Exportar archivo
        XLSX.writeFile(wb, 'observaciones_seguridad.xlsx');
        showAlert('Archivo Excel generado correctamente', true);
      } catch (error) {
        console.error('Error exportando a Excel:', error);
        showAlert('Error al generar Excel: ' + error.message, false);
      }
    }
  </script>
</body>
</html>
